# ElasticWave2D.jl 测试套件

## 测试结构

```
test/
├── runtests.jl           # 主测试入口
├── test_types.jl         # 类型系统测试
├── test_initialization.jl # 初始化函数测试
├── test_kernels.jl       # 数值内核测试 (含 CPU/GPU 一致性)
└── test_physics.jl       # 物理正确性测试 ⭐ 最重要
```

## 运行测试

### 运行所有测试
```julia
using Pkg
Pkg.activate("E:\\dev\\ElasticWave2D.jl")
Pkg.test()
```

### 运行单个测试文件
```julia
using Pkg
Pkg.activate("E:\\dev\\ElasticWave2D.jl")

include("test/test_types.jl")        # 只运行类型测试
include("test/test_physics.jl")      # 只运行物理测试
```

### 从命令行运行
```bash
cd E:\dev\ElasticWave2D.jl
julia --project=. -e "using Pkg; Pkg.test()"
```

## 测试类别说明

### 1. 类型测试 (`test_types.jl`)
- 验证类型继承关系（如 `ForceSource <: AbstractSource`）
- 测试数据结构的构造函数
- 参数验证

### 2. 初始化测试 (`test_initialization.jl`)
- FD 系数正确性
- Ricker 子波形状
- 介质初始化（padding、预计算字段）
- HABC 参数

### 3. 内核测试 (`test_kernels.jl`)
- 源注入（爆炸源、力源、应力源）
- 接收器录制（vz、vx、压力）
- CPU/GPU 一致性测试 ⚠️ 需要 GPU

### 4. 物理测试 (`test_physics.jl`) ⭐
这是最重要的测试类别！

| 测试 | 验证内容 |
|------|----------|
| Wave Propagation Speed | P 波速度是否正确 |
| Free Surface Reflection | 自由表面应力为零 |
| Absorbing Boundary | 吸收边界有效性 |
| Symmetry Test | 对称性（互易性基础） |
| Two-Layer Reflection | 双层模型反射波 |
| Numerical Stability | 数值稳定性（无 NaN/Inf）|

## 添加新测试

### 示例：添加能量守恒测试

```julia
@testset "Energy Conservation" begin
    # 在封闭系统（四边吸收边界）中
    # 总能量应该随时间衰减（被吸收），而不是增长
    
    # 1. 设置模型
    # 2. 运行模拟
    # 3. 计算不同时刻的总能量
    # 4. 验证能量单调递减
end
```

### 示例：添加互易性测试

```julia
@testset "Reciprocity" begin
    # 交换源和接收器位置
    # G(r_A, r_B) = G(r_B, r_A)
    
    # 1. 模拟：源在 A，接收器在 B
    # 2. 模拟：源在 B，接收器在 A
    # 3. 比较两个记录（应该相同）
end
```

## 预期输出

成功运行时：
```
Test Summary:       | Pass  Total
ElasticWave2D.jl    |   XX     XX
  Type Hierarchy    |   XX     XX
  Initialization    |   XX     XX
  Kernels           |   XX     XX
  Physical Tests    |   XX     XX
```

## 注意事项

1. **GPU 测试**：如果没有 GPU，GPU 相关测试会自动跳过
2. **物理测试较慢**：因为要运行完整模拟，可能需要 1-2 分钟
3. **临时文件**：物理测试会在系统临时目录创建输出文件

## CI/CD 集成

在 `.github/workflows/test.yml` 中：

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: julia-actions/setup-julia@v1
        with:
          version: '1.10'
      - uses: julia-actions/cache@v1
      - name: Run tests
        run: |
          julia --project=. -e 'using Pkg; Pkg.instantiate()'
          julia --project=. -e 'using Pkg; Pkg.test()'
```